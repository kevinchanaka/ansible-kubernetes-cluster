---
# Initialises control plane components on the main master node

- name: Check if kubernetes is already installed
  command: kubectl --kubeconfig {{ const.kubeconfig }} version
  ignore_errors: true
  failed_when: false
  changed_when: false
  register: kubernetes_installed_check

- name: Exit early if kubernetes is already installed
  fail:
    msg: "{{ kubernetes_installed_check.stdout }}"
  when: kubernetes_installed_check.rc == 0

- name: Copy kubeadm init config file
  template:
    src: "{{ inventory_dir}}/config/kubeadm-config.yaml"
    dest: "{{ const.kubeadm_config }}"

- name: Initialise control plane components
  command: kubeadm init --config {{ const.kubeadm_config }}

- name: Upload certificates to kubeadm-certs secret in kube-system namespace
  command: kubeadm init phase upload-certs --upload-certs --config {{ const.kubeadm_config }}
  register: kubeadm_certs

- name: Generate join command for other nodes
  command: kubeadm token create --print-join-command --config {{ const.kubeadm_config }}
  register: kubeadm_join_command

- name: Set join command in host variable
  add_host:
    name: kubeadm_join
    worker: "{{ kubeadm_join_command.stdout }}"
    master: "{{ kubeadm_join_command.stdout }} --control-plane --certificate-key {{ kubeadm_certs.stdout_lines[-1] }}"
